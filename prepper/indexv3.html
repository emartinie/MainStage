<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prepper PDF Library</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
  <style>
    /* Floating player */
    #floating-player {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 50;
    }
    #floating-player svg {
      transform: rotate(-90deg);
    }
    #floating-player.playing span {
      color: #fff;
    }
    .highlight { background-color: #fef3c7; } /* yellow highlight */
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

<div class="flex h-screen overflow-hidden">
  <!-- Sidebar -->
  <aside class="w-64 bg-gray-800 text-gray-100 flex-shrink-0 overflow-y-auto">
    <div class="p-4 text-lg font-bold border-b border-gray-700">Folders</div>
    <ul id="folder-list" class="p-2"></ul>
  </aside>

  <!-- Main content -->
  <main class="flex-1 overflow-y-auto p-4">
    <h1 class="text-2xl font-bold mb-4">PDF Library</h1>
    <!-- Advanced Search -->
    <input id="search-input" type="text" placeholder="Search PDFs..." class="mb-4 p-2 w-full border rounded shadow" />
    <div id="pdf-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </main>
</div>

<!-- Floating TTS player -->
<div id="floating-player" title="Play/Pause">
  <svg viewBox="0 0 36 36" class="w-20 h-20">
    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#eee" stroke-width="2"/>
    <path id="circle-progress" class="circle-progress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#10b981" stroke-width="2" stroke-dasharray="0,100" stroke-linecap="round"/>
  </svg>
  <span id="player-icon" class="absolute text-2xl text-white">▶️</span>
</div>

<script>
let pdfIndex = {};
const extractedTextCache = {}; 
let currentText = '';
let currentIndex = 0;
let speech = null;
const player = document.getElementById('floating-player');
const icon = document.getElementById('player-icon');
const progressPath = document.getElementById('circle-progress');

// Load JSON index
fetch('flat_index.json')
  .then(res => res.json())
  .then(data => {
    pdfIndex = data;
    renderFolders(data.folderMap);
    renderPDFs(data.files);
  });

// Sidebar folders
function renderFolders(folderMap){
  const folderList = document.getElementById('folder-list');
  folderList.innerHTML = '';
  for(const key in folderMap){
    const folder = folderMap[key];
    const li = document.createElement('li');
    li.className='p-2 hover:bg-gray-700 rounded cursor-pointer';
    li.textContent=`${folder.path} (${folder.pdfCount})`;
    li.onclick=()=>filterFolder(folder.path);
    folderList.appendChild(li);
  }
}

// PDF cards
let currentPDFs = [];
function renderPDFs(files){
  currentPDFs=files;
  const pdfContainer = document.getElementById('pdf-cards');
  pdfContainer.innerHTML='';
  files.forEach(file=>{
    const card = document.createElement('div');
    card.className='bg-white p-4 rounded shadow hover:shadow-lg transition';
    card.innerHTML=`
      <h2 class="font-bold text-lg">${file.name}</h2>
      <p class="text-sm text-gray-600">${file.category || ''}</p>
      <p class="text-sm text-gray-600">Pages: ${file.pdfPages || 'N/A'}</p>
      <p class="text-sm text-gray-600">Modified: ${file.modified ? new Date(file.modified).toLocaleDateString() : 'N/A'}</p>
      <button class="mt-2 bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700" onclick="playPDF('${file.path}')">Read</button>
    `;
    pdfContainer.appendChild(card);
  });
}

// Filter by folder
function filterFolder(folderPath){
  const filtered = pdfIndex.files.filter(f=>f.path.startsWith(folderPath));
  renderPDFs(filtered);
}

// Advanced search
document.getElementById('search-input').addEventListener('input',()=>{
  const term = document.getElementById('search-input').value.toLowerCase();
  const filtered = pdfIndex.files.filter(f=>
    f.name.toLowerCase().includes(term) ||
    (f.category && f.category.toLowerCase().includes(term)) ||
    (extractedTextCache[f.path] && extractedTextCache[f.path].toLowerCase().includes(term))
  );
  renderPDFs(filtered);
});

// Highlight text
function highlightText(text){
  const pdfContainer = document.getElementById('pdf-cards');
  pdfContainer.querySelectorAll('.highlight').forEach(el=>el.classList.remove('highlight'));
  const card = [...pdfContainer.children].find(c=>c.querySelector('h2').textContent.includes(text.slice(0,10)));
  if(!card) return;
  let paragraph = card.querySelector('p');
  if(paragraph) paragraph.classList.add('highlight');
}

// Floating player click
player.addEventListener('click',()=>{
  if(!speech) return;
  if(speechSynthesis.speaking){
    speechSynthesis.cancel();
    icon.textContent='▶️';
    player.classList.remove('playing');
  } else {
    startSpeech(currentText,currentIndex);
  }
});

// Play PDF
async function playPDF(path){
  currentText = extractedTextCache[path] || await extractPDFText(path);
  startSpeech(currentText);
}

// Extract PDF text
async function extractPDFText(path){
  const loadingTask = pdfjsLib.getDocument(path);
  const pdfDoc = await loadingTask.promise;
  let fullText='';
  for(let i=1;i<=pdfDoc.numPages;i++){
    const page = await pdfDoc.getPage(i);
    const content = await page.getTextContent();
    const pageText = content.items.map(item=>item.str).join(' ');
    fullText+=pageText+'\n\n';
  }
  extractedTextCache[path]=fullText;
  return fullText;
}

// Start speech with progress
async function startSpeech(text,startIndex=0){
  if(!('speechSynthesis' in window)){ alert('Browser does not support speech synthesis.'); return; }
  const paragraphs=text.split(/\n\n/).filter(p=>p.trim().length>0);
  for(let i=startIndex;i<paragraphs.length;i++){
    currentIndex=i;
    highlightText(paragraphs[i]);
    speech=new SpeechSynthesisUtterance(paragraphs[i]);
    speech.rate=1; speech.pitch=1; speech.lang='en-US';
    speechSynthesis.speak(speech);
    icon.textContent='⏸️';
    player.classList.add('playing');
    await new Promise(resolve=>{
      speech.onend=resolve;
      speech.onerror=resolve;
    });
    // Update circular progress
    const progressPercent=((i+1)/paragraphs.length)*100;
    progressPath.setAttribute('stroke-dasharray',`${progressPercent},100`);
  }
  icon.textContent='▶️';
  player.classList.remove('playing');
}
</script>
</body>
</html>
